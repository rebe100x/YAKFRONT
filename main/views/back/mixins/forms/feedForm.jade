mixin feedForm()
	button.btn#btnBack(style='display:none')
		i.icon-chevron-left
	form#feedform.yakForm(action='/feed', method='POST', enctype='multipart/form-data', style='display:none')
		input#yakcatInput(type='hidden', name='yakcatInput', value='')
		input#yakcatNames(type='hidden', name='yakcatNames', value='')
		input#address(type='hidden', name='address', value='')
		input#latitude(type="hidden", name="latitude")
		input#longitude(type="hidden", name="longitude")
		input#update(type="hidden", name="update", value='0')
		input#objid(type="hidden", name="objid", value='0')

		legend Ajouter un flux
		div.control-group.error
				div.controls
					label.alert#err(type="text", id="err", name="err", style='display:none') Les champs en rouge sont obligatoires.
		div.control-group#titleGroup
			div.controls
				.col
					label Nom:
					input(type='text', name='humanName', id='humanName', placeholder='Le nom du flux')
				.col
					label Lien externe:
					input(type='text', name='link', id='link', placeholder='Lien vers la source de la donnée')
				.col	
					label Licence:
					input(type='text', name='licence', id='licence', placeholder='Licence')
				.col
					label Combien de jours l info restera sur le front ?
					div.input-append.dropdown.combobox#persistDays
						input(type='text', placeholder="Jours de persistence")
						button.btn(data-toggle="dropdown")
							i.caret
						ul.dropdown-menu
							li(data-value="1")
								a(href="") 1
							li(data-value="2")
								a(href="") 2
							li(data-value="3")
								a(href="") 3
							li(data-value="7")
								a(href="") 7
							li(data-value="30")
								a(href="") 30
							li(data-value="90")
								a(href="") 90
							li(data-value="365")
								a(href="") 365
		
		legend Metadata:		
		div.control-group#statusGroup.clearBoth
			.col
				label Type d info:
				label.radio.inline Actu
					input(type="radio", name="yakType", value="1")
				label.radio.inline Agenda
					input(type="radio", name="yakType", value="2")
				label.radio.inline Info pratiques
					input(type="radio", name="yakType", value="3")
			
		div.control-group#dataGroup.clearBoth
			div.controls	
				.col
					label(for='category') Catégories
					input#yakcat(type="text", data-provide="typeahead", name="yakcat", autocomplete="off", placeholder='Chercher une catégorie...')
					.pillbox#pillYakcat(style="display:none")
						ul
				.col
					label Tags
					.input-append
						input#freetag(type="text", data-provide="typeahead", name="freetag", autocomplete="off", placeholder='Entrer un tag...')
						button.btn#btn-freetag-adder(type="button") Ajouter	
					.pillbox#pillFreetag(style="display:none")
						ul						
		

			
		legend Localisation:						
		div.control-group#locationGroup.clearBoth
			.col
				label(for='Place') Localisation du flux
				.input-append
					input(type="text",data-provide="typeahead", id="place", name="place", autocomplete="off", placeholder="Chercher une ville, département, ou région")
			.col
				label Si l'info n'est pas géolocalisée...	
				
				div.input-append.dropdown.combobox#defaultPrintFlag
					input(type='text', placeholder="Si l'info n'est pas géolocalisée... ")
					button.btn(data-toggle="dropdown")
						i.caret	
					ul.dropdown-menu
						li(data-value="0")
							a(href="") ... ne pas afficher sur la carte mais afficher sur le fil info
						li(data-value="1")
							a(href="") ... afficher sur la carte + fil info
						li(data-value="3")
							a(href="") ... ne pas afficher l info du tout
						li(data-value="2")
							a(href="") ... ne pas faire de géoloc et la placer au point par défaut
		legend Parsing:
		div.control-group#parsingGroup.clearBoth
			label Type de flux : 
				div.select.btn-group#feedType
					button.btn.dropdown-toggle(data-toggle="dropdown")
						span.dropdown-label Type de flux 
						span.caret
					ul.dropdown-menu
						li(data-value="RSS")
							a(href="") RSS
						li(data-value="CSV")
							a(href="") CSV
						li(data-value="YAKMADE")
							a(href="") YAKMADE

				
				
			label Source(s)
			.input-append	
				input.big(type='text', name='source', id='source', placeholder='source')
				button.btn#btn-source-adder(type="button") Ajouter
			.pillbox#pillSource(style="display:none")
				ul	
	
		div.control-group#parsingGroup.clearBoth
				label &nbsp;
				button.btn.btn-primary.btn-warning(type='button', name='parsing', id='parsing') Définir le parsing
		
					
					

		div.control-group
			div.controls
				label.radio.inline Actif
					input(type="radio", name="status", value="1")
				label.radio.inline Inactif
					input(type="radio", name="status", value="0")	
							
		div.control-group
			div.controls
				button.btn.btn-large.btn-inverse(type='submit', name='submit', id='submit', value='Enregistrer') Enregistrer

			
	script

		$(document).ready(function() {

			$('#feedform input:radio[name=yakType]').click();

			$('#btn-freetag-adder').on('click',function(event){
				event.preventDefault();
				$("#pillFreetag ul").append("<li class='freetag-val' data-value='null'>"+$('#freetag').val()+"</li>");
				$('#freetag').val('').focus();
				return false;
			});	
			$('#yakcat').typeahead({
				minLength : 3,
				source: function (typeahead, query) {
					$.ajax({
							dataType: "json",
							url: "/api/cats",				
							success: function( ajax ) {
								typeahead.process(ajax.data.cats);
							}
						})},
				property: "title",
				onselect: function(obj) { 
					$("#pillYakcat ul").append("<li class='yakcat-val status-important' data-value='"+obj._id+"'>"+obj.title+"</li>");
					$('#yakcat').val('').focus();
				}
			});

			
			$('#freetag').typeahead({
				minLength : 3,
				source: function (typeahead, query) {
					$.ajax({
							dataType: "json",
							url: "/api/tags",				
							success: function( ajax ) {
								typeahead.process(ajax.data.tags);
							}
						})},
				property: "title",
				onselect: function(obj) { 
					$("#pillFreetag ul").append("<li class='freetag-val status-info' data-value='"+obj._id+"'>"+obj.title+"</li>");
					$('#freetag').val('').focus();
				}
			});

			$('#btn-source-adder').unbind('click').on('click',function(){
				$("#pillSource").show();
				$("#pillSource ul").append("<li class='source-val status-warning' data-value='"+$('#source').val()+"'>"+$('#source').val()+"</li>");
				$('#pillSource').val('').focus();
			});

			

			/*Place autocomplete*/

			var input = document.getElementById('place');
			$('#place').on('focus',function(){$(this).val('');});
			var autocomplete = new google.maps.places.Autocomplete(input);
			autocomplete.bindTo('bounds', map);
			google.maps.event.addListener(autocomplete, 'place_changed', function() {
				infowindow.close();
				$('#placeForm #btn-place-adder').click();
				var place = autocomplete.getPlace();
				if (!place.geometry) {
					// Inform the user that the place was not found and return.
					input.className = 'notfound';
					return;
				}

				// If the place has a geometry, then present it on a map.
				if (place.geometry.viewport) {
					map.fitBounds(place.geometry.viewport);
				} else {
					map.setCenter(place.geometry.location);
					map.setZoom(17);  // Why 17? Because it looks good.					
					$("#feedform #longitude").val(place.geometry.location.Za);
					$("#feedform #latitude").val(place.geometry.location.Ya);
					$("#feedform #address").val(place.formatted_address);
					
				}
				markerLocation.setPosition(place.geometry.location);

			});


			/*// bind 'myForm' and provide a simple callback function
			$('#feedForm').ajaxForm(function() {
				$("#MyGrid").fadeIn();
				$("#feedForm").hide();
				$("#btnBack").hide();
				google.maps.event.removeListener(listenerHandle);
				markerLocation.setVisible(false);
				refreshDatagrid();
			});*/


		});