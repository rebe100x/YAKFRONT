extends ../layout
block content
	include ../mixins/menu.jade
	include ../mixins/locationChooser.jade
	include ../mixins/forms/postForm.jade
	include ../mixins/forms/loginForm.jade
	include ../mixins/forms/searchForm.jade
	mixin menu('map')
	mixin locationChooser('map')


	div.container-fluid
		div.row-fluid
			div.span8
				div#mymap
				div#zoomnavigation
					div#zoomplus
					div#zoomminus
			div.span4
				div#newsfeedContainer
					div#boxOpener.row.opened Chercher & Filtrer
					div#searchForm
						mixin searchForm('map')
						
					span#newsNav				
						ul.nav.nav-tabs
							li.active(contentToLoad="newsfeedContent")
								a.newsNavItem#newsFeed(href="#") Le fil
							- if(session)	
								li(contentToLoad="newspostContent")
									a.newsNavItem#newsPost(href="#") Poster
									
					span#newsfeedContent.tabContent			
						ul#newsfeed
					span#newspostContent.tabContent
						mixin postForm()
					
	//script(src='http://maps.google.com/maps/api/js?v=3.9&sensor=false&libraries=drawing')		
	link(rel='stylesheet', href='/javascripts/lib/jquery/css/share.css')
	script(src="/javascripts/lib/jquery/js/timeago.js")	
	script(src="/javascripts/lib/jquery/js/share.js")	
	script(src="/javascripts/lib/jquery/js/jquery.livequery.js")
	script(src="/javascripts/json2.js")	
	script
	
	

		/*INIT*/
		var conf = !{conf};
		var mainConf = !{mainConf};	
		
		
		var geolocalized = 0;
		var infowindow = null;
		var bounds = new Array();
		var markers = [];
		var infoArray = [];
		var markerLocation = null;
		var yakcatArray = [];
		var placeArray = [];
		var hashtag = [];
		var hashtagTmp = [];
			
		var markerClustererOptions = {gridSize:30,maxZoom: 17,styles: [{height: 28,width: 28,url: "/images/markers/m1.png"},{height: 38,width: 38,url: "/images/markers/m2.png"},{height: 55,width:55,url: "/images/markers/m3.png"},{height: 85,width: 85,url: "/images/markers/m4.png"},{height: 85,width: 85,url: "/images/markers/m5.png"}]};
		var markerCluster = null;
		var pinkParksStyles = [{featureType: "Water",stylers: [{ hue: "#006eff" },{ saturation:1 },{ lightness: -13 }]},{featureType: "Road",stylers: [{ hue: "#ff0000" },{ saturation: -100 },{ lightness: 31 }]},{featureType: "Landscape",stylers: [{ hue: "#ff0008" },{saturation: -90 },{ lightness: 66 }]}];
		var pinkParksStyles =[{}];
		
		var skip = 0;
		var zoom = 1;
		var infoContent = '';
		var rule = new RegExp('#([^\\s]*)','g');
		var rule2 = new RegExp('[#]','g');
		var postFlag = 0;
		var listenerHandle = null;
		
		var map = new google.maps.Map(document.getElementById('mymap'), {
				mapTypeId: google.maps.MapTypeId.ROADMAP,
				disableDefaultUI: true,
			});

		setInterval(function() {
				silentUpdater();			
			}, 10000);

		/*READY FUNCTIONS*/
		$(document).ready(function() {
			zoom = rangeFromZ();
			
			$('#arroundme').click(function(){

				if(user.location){
					var latLng = new google.maps.LatLng(user.location['lat'],user.location['lng']);
					curPos.name = user.formatted_address;
					curPos.x =  user.location.lat;
					curPos.y =  user.location.lng;
					curPos.z = mainConf.searchParams.sliderDefault;
					$("#searchPlaceStr").val(curPos.name);
					$("#rangeSelector").find("a.ui-slider-handle").css("left", curPos.z + "%");
					$("#rangeSelector").find("div.ui-slider-range").css("width", curPos.z + "%");
					setLocalnessSliderText(curPos.z);
					moveMap();
					//map.setCenter(latLng);
				}else{
					window.location = '/settings/profile';
				}
			});


			/*map tools*/
			$('#zoomplus').click(function () {	  
				zoom = map.getZoom();
				zoom++;
				map.setZoom(zoom);	
				changeZoom();
				
			});

			$('#zoomminus').click(function () {
				zoom = map.getZoom();
				zoom--;
				map.setZoom(zoom);
				changeZoom();
				
			});

			
			/*control opener*/
			$('#boxOpener').click(function(event){
				event.preventDefault();
				if($(this).hasClass('opened')){
					$(this).removeClass('opened').addClass('closed');
					$('#newsfeedMenu').animate({height:'0px',opacity:0},200,function(){drawNewsFeed();});	
				}else{
					$(this).removeClass('closed').addClass('opened');
					$('#newsfeedMenu').animate({height:'140px',opacity:1},200,function(){drawNewsFeed();});
				}
			});

			/*news nav*/
			$('#newsNav li').click(function(event){
				event.preventDefault();
				
				if(!$(this).hasClass('active')){
					$('#newsNav li').removeClass('active');	
					$(this).addClass('active');
					var contentToLoad = $(this).attr('contentToLoad');
					
					$('.tabContent').hide();
					$('#'+contentToLoad).fadeIn();	
					
					if(contentToLoad == "newspostContent"){
						// INIT MARKERLOCATION
						
						listenerHandle = google.maps.event.addListener(map, 'click', function(event) {
							getformattedAddress(event.latLng);
							placeMarker(event.latLng,markerLocation);
							google.maps.event.addListener(markerLocation, 'dragend', function() {
								cleanMarkers();
								var position = markerLocation.getPosition();
								$('#latitude').val(position.lat());	
								$('#longitude').val(position.lng());	
								
								getformattedAddress(position);
								
							});		
						});
					}
					else{
						google.maps.event.removeListener(listenerHandle);
						markerLocation.setVisible(false);
					}
				}
					drawNewsFeed();
			});
				
			
			
			
			
			// init news feed
			drawNewsFeed();

			$('#newsfeedContent').mCustomScrollbar({mouseWheel:true,callbacks:{onTotalScroll:printArrayFeedItem},scrollButtons:{enable:true,scrollType:"continuous",},advanced:{autoExpandHorizontalScroll:true,updateOnContentResize: true,updateOnBrowserResize:true}});
			$('#newspostContent').mCustomScrollbar({mouseWheel:true,scrollButtons:{enable:true,scrollType:"continuous",},advanced:{autoExpandHorizontalScroll:true,updateOnContentResize: true,updateOnBrowserResize:true}});
			$(window).resize(function(){
				drawNewsFeed();
				bounds = getMyBounds();
				manageSearchBox();
			});
			
			$('#newsfeed').delegate(".mapHighlighter",'click', function (e) {
				//console.log(e.target);
				if (e.target.className != "yakComments" && e.target.className != "yakLikes" && e.target.className != "yakTextarea" && e.target.className != "username")
					getItemDetails(this);
				unhighlightInfo($(this),highlightInfo);
			});

			
			
			/*cookies for navigation*/
			google.maps.event.addDomListener(window, 'load', initialize(curPos.x,curPos.y,curPos.z));
			/*
			if(!$.isEmptyObject($.cookie("geoloc"))){
				curPos = JSON.parse($.cookie("geoloc"));
				google.maps.event.addDomListener(window, 'load', initialize(curPos.x,curPos.y,curPos.z));
			}else{
				if(navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(getHTML5Pos,getErrHTML5Pos);
				}else {
					x = 48.851875;
					y = 2.356374;
					z = 13;
					curPos = {'x':x,'y':y,'z':z};
					google.maps.event.addDomListener(window, 'load', initialize(curPos.x,curPos.y,curPos.z));
				}
			}*/
			
			
			/*POST EFFECTS*/
			// hashtag creation from title field
				$(".hashtagMaker").keyup(function(event) {
					hashtagTmp = [];
					var inputStrArray = ($('#content').val()+' '+$('#title').val()).split(' ');
					for(i = 0; i< inputStrArray.length;i++){
						if(inputStrArray[i].match(rule)){
							hashtagTmp.push(inputStrArray[i]);
							$('#freetag').val(hashtagTmp.toString().replace(rule2,''));
						}
					}
				});
				
				
				
				$('#picture').live('change', function () {

					if ( window.FileReader ) {
						var fileList = this.files;
						var file = fileList[0];
						var r = new FileReader();
						r.onload = function () {
							var binimage = r.result;
							binimage1 = binimage.replace('data:'+file.type+';base64,', '');
							var imag = "<img class='img-rounded' " + "src='" + 
							"data:"+file.type+";base64," + binimage1 + "' style='width:100px'/>";
							$("#picturePreview").html(imag);
						};
						r.readAsDataURL(file);
					
					}
					
					//r.readAsBinaryString(file);

					

				});

				
				
				markerLocation = new google.maps.Marker({
					visible:false,
					map:map,
					draggable:true,
					icon:'/images/beachflag.png',
					//position:center
				});
				
				$('#yakcat').typeahead({
					minLength : 3,
					source: function (typeahead, query) {
						$.ajax({
								url: "/api/cats",				
								success: function( ajax ) {
									typeahead.process(ajax.data.cats);
								}
							})},
					property: "title",
					onselect: function(obj) { 
						$("label[for='category']").after("<div class='pillItem'><i class='icon-remove icon-pointer'  onclick='yakcatArray.cleanArray(\""+obj._id+"\");$(\"#yakcatInput\").val(JSON.stringify(yakcatArray));$(this).parent().remove();'></i> "+obj.title+"</div>");
						$('#yakcat').val('').focus();
						yakcatArray.push(obj);
						$("#yakcatInput").val(JSON.stringify(yakcatArray));
					}
				});
				
				/*
				$('#place').typeahead({
					minLength : 3,							
					source: function (typeahead, query) {
						$.ajax({
								url: "/api/places",		
								success: function( ajax ) {
									typeahead.process(ajax.data.places);
								}
							})},
					property: "title",
					onselect: function(obj) { 
						$('#btn-place-adder').parent().before("<div><i class='icon-remove icon-pointer'  onclick='placeArray.cleanArray(\""+obj._id+"\");$(\"#placeInput\").val(JSON.stringify(placeArray));$(this).parent().remove();'></i> "+obj.title+"</div>");
						$('#place').val('').focus();
						placeArray.push(obj);
						$("#placeInput").val(JSON.stringify(placeArray));
					}
				});*/
					// autocomplete Place
				$('#place').typeahead({
					minLength : 3,							
					source: function (typeahead, query) {
						if(query.length >= 3){
							encodeURIComponent(query);
							$("#place").addClass('searching');
							var addressQuery = {"address": query ,"region":"fr","language":"fr"};
							var geocoder = new google.maps.Geocoder();
							geocoder.geocode( addressQuery, function(results, status) {						
							if (status == google.maps.GeocoderStatus.OK) {
								typeahead.process(results);
								$("#place").removeClass('searching');
							} 
							});
						}
					},
					property: "formatted_address",
					onselect: function(obj) { 
						var placeGmap = getPlaceFromGmapResult(obj);
						$('#btn-place-adder').parent().before("<div class='pillItem'><i class='icon-remove icon-pointer'  onclick='placeArray.cleanArrayByLocation(\""+placeGmap.location.lat+","+placeGmap.location.lng+"\");$(\"#placeInput\").val(JSON.stringify(placeArray));$(this).parent().remove();'></i> "+placeGmap.title+"</div>");
						$('#place').val('').focus();
						placeArray.push(placeGmap);
						$("#placeInput").val(JSON.stringify(placeArray));
					}
				});

				
				$('#btn-place-adder').click(function(){
					var addressString = $('#place').val();
					if(addressString != "Rechercher..." && addressString != "" && addressString.length > 1){
						var addressQuery = {"address": addressString,"latLng":map.getCenter(),"bounds":map.getBounds()};
						var geocoder = new google.maps.Geocoder();
						geocoder.geocode( addressQuery, function(results, status) {
							if (status == google.maps.GeocoderStatus.OK) {
								//map.setCenter(results[0].geometry.location);
								map.panTo(results[0].geometry.location);
								markerLocation.setVisible(true);
								markerLocation.setPosition(results[0].geometry.location);
								placeMarker(results[0].geometry.location,markerLocation);
								var placeGmap = getPlaceFromGmapResult(results[0]);
								placeArray.push(placeGmap);
								$("#placeInput").val(JSON.stringify(placeArray));
								$('#btn-place-adder').parent().before("<div class='pillItem'><i class='icon-remove icon-pointer' onclick='placeArray.cleanArrayByLocation("+results[0].geometry.location.Ya+","+results[0].geometry.location.Za+");$(\"#placeInput\").val(JSON.stringify(placeArray));$(this).parent().remove();'></i> "+results[0].formatted_address+"</div>");
								
							} else {
								var salt = new Date().getTime();
								$('#btn-place-adder').parent().before("<div id='alert"+salt+"' class='control-label'><i class='icon-exclamation-sign'> </i>Adresse invalide ("+status+")</div>");
								setTimeout(function() {
									$("#alert"+salt).fadeOut();
								}, 3000);
								$('#place').select();
							}
						});
					}
					
					
				});
			
			
			/*linkify*/
			$("body").delegate('.tagHashLink','click',function(event){
				//event.preventDefault();
				searchString = $(this).html();
				
				
				$('#searchStr').val(searchString);
				//searchString = encodeURIComponent(searchString);
				
				getAndPrintInfo();
			});
			$("body").delegate('.userHashLink','click',function(event){
				event.preventDefault();
				searchString = $(this).html();
				
				$('#searchStr').val(searchString);
				//searchString = encodeURIComponent(searchString);
				
				getAndPrintInfo();
			});
			
				
			manageSearchBox();

			

		});/*END READY*/

		function placeMarker(location,mk) {
			$('#latitude').val(location.lat());	
			$('#longitude').val(location.lng());	
			mk.setVisible(true);
			mk.setPosition(location);
		}

		function moveMap(){
			$.cookie("geoloc", JSON.stringify(curPos),{ expires: 10000 ,path:'/'});
			var latLng = new google.maps.LatLng(curPos.x,curPos.y);
			$('#locationChooser').modal('hide');
			if($('#mymap').length > 0){ // only for the map page
				map.panTo(latLng);
				//google.maps.event.addDomListener(window, 'load', initialize(curPos.x,curPos.y,10)); 
			}
			
		}

		function updateXY(){
				
			var id = $(this).attr('id');
			switch(id){
			case 'zone1':
				x = 48.851875;
				y = 2.356374;
				z = 13;
			break;
			case 'zone2':
				x = 43.610787;
				y = 3.876715;
				z = 14;
			break;
			case 'zone3':
				x = 50.583346;
				y = 4.900031;
				z = 14;
			break;
			default:
				x = 48.851875;
				y = 2.356374;
				z = 13;
			}
			curPos = {'x':x,'y':y,'z':z};

			//socket.emit('position', curPos);
			
			//console.log(curPos);
					
			$('#locationChooser').modal('hide');
			
			if($('#mymap').length > 0){ // only for the map page
			// NOTE : initialize function is defined in map.jade and in new.jade : just a bit fifferent to deal the insertion
				google.maps.event.addDomListener(window, 'load', initialize(curPos.x,curPos.y,curPos.z)); 
			}
			//return curPos;
		}

		function changeLocation(location){
			var locationObj = JSON.parse(location);
			var latLng = new google.maps.LatLng(locationObj.lat,locationObj.lng);
			markerHL.setPosition(latLng);
			markerHL.setVisible(true);
			markerHL.setMap(map);
			markerHL.setOptions({icon:"/images/markers/target3.png"});
			setTimeout(function() {
				markerHL.setMap(null);
			}, 3000);
			map.panTo(latLng);

		}
		function manageSearchBox(){
			var width = $(window).width();
			if(width<960){
				$('#boxOpener').removeClass('opened').addClass('closed');
				$('#newsfeedMenu').animate({height:'0px',opacity:0},200,function(){drawNewsFeed();});
			}else{
				$('#boxOpener').removeClass('closed').addClass('opened');
				$('#newsfeedMenu').animate({height:'140px',opacity:1},200,function(){drawNewsFeed();});
			}


		}
		/* getMyBounds
		* calculate bounds according to screen size and feed position.
		*/
		function getMyBounds(){
			thebounds = map.getBounds();
			/*console.log('ca.f:lat max'+thebounds.ca.f);
			console.log('ca.b: lat min'+thebounds.ca.b);
			console.log('ea.f: lng max'+thebounds.ea.f);
			console.log('ea.b:lng min'+thebounds.ea.b);*/
			var width = $(window).width();
			var height = $(window).height();
			var pos = $("#newsfeedContainer").position();
			var scaleW = (parseFloat(thebounds.ea.f) - parseFloat(thebounds.ea.b)) / width ;
			var scaleH = (parseFloat(thebounds.ca.f) - parseFloat(thebounds.ca.b)) / height ;
			var feedOffsetW = pos.left * scaleW;
			var feedOffsetH = pos.top * scaleH;
			var borderOffsetW = 15 * scaleW;
			var borderOffsetHTop = 70 * scaleH;
			var borderOffsetHBottom = 0 * scaleH;
			
			if(width>768){
				var myBounds = {
					ca:{
						f: thebounds.ca.f-borderOffsetHTop,
						b: thebounds.ca.b+borderOffsetHBottom,	
					},
					ea:{
						f: thebounds.ea.b+feedOffsetW-borderOffsetW,
						b: thebounds.ea.b+borderOffsetW,
					}
				};
			}else{
				var myBounds = {
					ca:{
						f: thebounds.ca.f-borderOffsetHTop,
						b: thebounds.ca.f-feedOffsetH+borderOffsetHBottom,	
					},
					ea:{
						f: thebounds.ea.f-borderOffsetW,
						b: thebounds.ea.b+borderOffsetW,
					}
				};
			}
			
			
			
			return myBounds;
		}

		function drawNewsFeed(){	
			var newsfeedContainerHeight = window.innerHeight-$('#newsfeedContainer').offset().top-0+'px';
			$('#newsfeedContainer').css('height',newsfeedContainerHeight);
			var width = $(window).width();
			if(width < 767)
				$('#newsfeedContainer').css('top','300px');
			else
				$('#newsfeedContainer').css('top','10px');
			var newsfeedContentHeight = window.innerHeight-$('#newsfeedContent').offset().top-0+'px';
			$('#newsfeedContent').css('height',newsfeedContentHeight);
			$('#newsfeedContent').mCustomScrollbar("update");

			var newspostContentHeight = window.innerHeight-$('#newspostContent').offset().top-0+'px';
			$('#newspostContent').css('height',newspostContentHeight);

			$('#newspostContent').mCustomScrollbar("update");
		}
		
		function unhighlightInfo(obj,callback){
			markerHL.setAnimation(null);
			markerHL.setVisible(false);
			
			if (callback && typeof(callback) === "function") {  
				callback(obj);  
			} 
		}
		
		function highlightInfo(obj){
			var id = obj.attr('infoId');
			
			$.each(infoArray,function(key,val){
				
				if(val._id == id){
					// hide all markers
					//hideMarkers(7000);
					
					// clean if a marker is already highlighted
						
					var latLng = new google.maps.LatLng(val.location['lat'],val.location['lng']);
					markerHL.setPosition(latLng);
					markerHL.setVisible(true);
					markerHL.setMap(map);
					markerHL.setAnimation(google.maps.Animation.BOUNCE);
					markerHL.setOptions({icon:"/images/markers/type"+val.yakType+".png"});
					
					//$("ul#newsfeed li.mapHighlighterDetails").fadeOut().html('');
					//$("ul#newsfeed li.mapHighlighterDetails[infoid="+id+"]").fadeIn();
				
					// center map
					//map.setCenter(latLng);
					//map.panTo(latLng);
					
					// clear marker ( and infowindow )
					setTimeout(function() {
						
						//markerHL.setAnimation(null);
						//markerHL.setVisible(false);
						markerHL.setMap(null);
						
					}, 2000);
				}
			});
		}

		function rangeFromZ(){
			return Math.floor((curPos.z)/10+4);
		}
		function zFromRange(){
			return Math.floor((zoom-4)*10);
		}

		function changeRange(){
			zoom = rangeFromZ();
			map.setZoom(zoom);
			$.cookie("geoloc", JSON.stringify(curPos),{ expires: 10000, path : '/' });
		};
		function changeZoom(){
			curPos.z  = zFromRange();
			setLocalnessSliderText(curPos.z);	
			$("#rangeSelector").val(curPos.z).slider('value',curPos.z);
			$.cookie("geoloc", JSON.stringify(curPos),{ expires: 10000, path : '/' });
			
		};

		function initialize(x,y,z){
			// set user cookies
			//$.cookie("geoloc", JSON.stringify(curPos),{ expires: 10000, path : '/' });
			var center = new google.maps.LatLng(x,y);
			infowindow = new google.maps.InfoWindow({content: ".",maxWidth : 300});
			/*map = new google.maps.Map(document.getElementById('mymap'), {
				zoom: zoom,
				center: center,
				mapTypeId: google.maps.MapTypeId.ROADMAP,
				disableDefaultUI: true,
			});*/
			map.setZoom(zoom);
			map.setCenter(center);
			
			map.setOptions({styles: pinkParksStyles});
			//var markerClustererOptions = {gridSize:30,maxZoom: 17,styles: [{height: 28,width: 28,url: "/images/markers/m1.png"},{height: 38,width: 38,url: "/images/markers/m2.png"},{height: 55,width:55,url: "/images/markers/m3.png"},{height: 85,width: 85,url: "/images/markers/m4.png"},{height: 85,width: 85,url: "/images/markers/m5.png"}]};
			//markerCluster = new MarkerClusterer(map, markers,markerClustererOptions);
			
			markerHL = new google.maps.Marker({position: center,map:map,visible:false});
			
			google.maps.event.addListener(map, 'idle', function() {
				cleanMarkers();
				bounds = getMyBounds();
				center = this.getCenter();
				curPos.x = center.lat();
				curPos.y = center.lng();
				zoom = this.getZoom();
				curPos.z = zFromRange();
				$.cookie("geoloc", JSON.stringify(curPos),{ expires: 10000, path : '/' });
				//markerCluster.clearMarkers();
				getAndPrintInfo();
			});
			
			
			
		}
		
		function cleanMarkers(){
		// clean existing markers
			$.each(markers,function(key,val){
					val.setMap(null);
			});
			
			markers = [];
			//markerCluster.clearMarkers();
		}
		
		function hideMarkers(ms){
		// hide existing markers for ms milisec
			//markerCluster.clearMarkers();
			$.each(markers,function(key,val){
					val.setVisible(false);
			});
			setInterval(function() {
				$.each(markers,function(key,val){
					val.setVisible(true);
				});
				//markerCluster.addMarkers(markers);
			}, ms);
			
		}
		
		function silentUpdater(){
			
			searchString = encodeURIComponent(searchString);		
			//bounds = map.getBounds();
			bounds = getMyBounds();
			var apiUrl = '';
			if(yakType.toString() == 5)
				apiUrl = '/api/geoalerts/'+bounds.ca.b+'/'+bounds.ea.b+'/'+bounds.ca.f+'/'+bounds.ea.f+'/'+dateFrom+'/0/'+searchString+'/500';
			else	
				apiUrl = '/api/geoinfos/'+bounds.ca.b+'/'+bounds.ea.b+'/'+bounds.ca.f+'/'+bounds.ea.f+'/'+dateFrom+'/0/'+yakType.toString()+'/'+searchString+'/500';
			

			$.getJSON(apiUrl,function(ajax) {	
				$.each(ajax.data.info, function(key,val) {
					
					

					var flagExists = 0;
					
					$.each(infoArray,function(key2,val2){
						if(val2._id == val._id){
							flagExists = 1;
						}
					});
					
					if(flagExists == 0){

						printMapItem(val,key,1);
						printFeedItem(val,1,0);	
					
						
						infoArray.push(val);	
						
						
						
					}
				});
			});
		}
		
		function getAndPrintInfo(){
			infoArray = [];
			bounds = getMyBounds();
			//console.log(curPos.z);
			drawNewsFeed();
			
			cleanMarkers();
			searchString = encodeURIComponent(searchString);
			
			if(typeof(yakType) == 'undefined' || yakType.length == 0){
				printEmptyFeedItem();
				return;
			}

			var apiUrl = '';
			if(yakType.toString() == 5)
				apiUrl = '/api/geoalerts/'+bounds.ca.b+'/'+bounds.ea.b+'/'+bounds.ca.f+'/'+bounds.ea.f+'/'+dateFrom+'/0/'+searchString+'/500';
			else	
				apiUrl = '/api/geoinfos/'+bounds.ca.b+'/'+bounds.ea.b+'/'+bounds.ca.f+'/'+bounds.ea.f+'/'+dateFrom+'/0/'+yakType.toString()+'/'+searchString+'/500';
			
			
			$.getJSON(apiUrl,function(ajax) {	
			
				// empty the news feed
				$('#newsfeed').html('');

				if(typeof(ajax.data.info) == 'undefined' || ajax.data.info.length == 0){
					//$('#newsfeed').html('Aucune info !');
					printEmptyFeedItem();
				}else{
					
					$.each(ajax.data.info, function(key,val) {
						
						infoArray.push(val);					
						printMapItem(val,key,0);
						if(key<10)
							printFeedItem(val,0,0);	
					});
				printLoadingFeedItem();	
				//markerCluster.addMarkers(markers);
				}
				$("abbr.timeago").timeago();
				$('#newsfeedContent').mCustomScrollbar("update");
			});

		}

		function printMapItem(item,key,bounce){
			var latLng = new google.maps.LatLng(item.location['lat'],item.location['lng']);
			var marker = new google.maps.Marker({position: latLng,icon:"/images/markers/type"+item.yakType+".png"});
			markers.push(marker);
			marker.setMap(map);	
			google.maps.event.addListener(marker, 'click', function() {
				//cleanMarkers();
				$("#newsfeed li").removeClass('highlighted');
				$("#newsfeed li[infoId=\""+item._id+"\"]").addClass('highlighted');
				if(typeof($(".mapHighlighter[infoId=\""+item._id+"\"]").html()) != 'undefined')
					$('#newsfeedContent').mCustomScrollbar("scrollTo",".mapHighlighter[infoId=\""+item._id+"\"]");
				else{
					printFeedItem(infoArray[key],1,1);
				}
			});	

			if(bounce == 1){
				marker.setAnimation(google.maps.Animation.BOUNCE);
				setTimeout(function() {
					marker.setAnimation(null);
					//markerCluster.addMarker(marker);
				}, 5000);
			}
		}

		function printFeedItem(item,top,scrollTo){
			
			if(item.yakCatName.length > 0){
				var yakCatNameArray = item.yakCatName.map(function(item){
					if(item.substr(0,1)!="#")
						item = "#"+item;
					return item.linkify();
				});	
				yakCatNameArray = yakCatNameArray.slice(0,3);
			}else
				var yakCatNameArray = new Array();
		
			if(typeof(item.freeTag[0]) != 'undefined' && item.freeTag[0].length > 0){
				var tagNameArray = item.freeTag.map(function(item){
					if(item.substr(0,1)!="#")
						item = "#"+item;
					return item.linkify();
				});
				tagNameArray = tagNameArray.slice(0,3);
			}else
				var tagNameArray = new Array();
				
			var dateTmp = new Date(item.pubDate);
			var pubDate = dateTmp.getDate()+'/'+(dateTmp.getMonth()+1)+'/'+dateTmp.getFullYear();
			dateTmp = new Date(item.dateEndPrint);
			var dateTmp2 = new Date(item.dateEndPrint);
			var dateEndPrint = dateTmp2.getDate()+'/'+(dateTmp2.getMonth()+1)+'/'+dateTmp2.getFullYear();

			infoContent = "<div class=\'infowindow mapHighlighter\' infoId='"+item._id+"'>";					
			
			if(!(typeof item.thumb === 'undefined') && item.thumb != '' && item.thumb != null)
				infoContent += "<img src=\'"+item.thumb+"\' />";

			infoContent += "<div class=\'title\'> <img class='yakTypeImg' src=\'/images/markers/type"+item.yakType+".png\' />";
			

			thedate = buildItemDate(item);
				
			
			infoContent += "<span class=\'date\'>"+thedate+"</span>";
			
			infoContent += item.title.linkify()+"</div>";

			infoContent += "<div class=\'tags\'>";					
				
			if(item.yakCatName.length > 0)
				infoContent += yakCatNameArray.join(', ');

			if(tagNameArray.length > 0){
				if(item.yakCatName.length > 0)
					infoContent += ', ';
				infoContent += tagNameArray.join(', ');
			}
			infoContent += "</div>";

			infoContent += "<div class=\'links\'>";					
				if(item.origin && item.origin !=  'undefined'){
					if(item.origin.substring(0,1) == '@')
						infoContent += "<div class=\'\'>Posté par <a href='/news/map/search/"+encodeURIComponent(item.origin)+"'>"+item.origin+"</a></div>";
					else
						infoContent += "<div class=\'\'>Posté par <a target='_blank' href='"+item.outGoingLink+"'>"+item.origin+"</a></div>";
				}
			if(typeof(item.address) != 'undefined' && item.address != 'null' && item.address != '')
					infoContent += "<div class=\'infodetail\'>"+item.address+"</div>";
					if(user.login == 'renaud.bessieres') /// this is debug
						infoContent += "<div class=\'infodetail\'>"+pubDate+" >> "+dateEndPrint+"</div>";
			infoContent += "</div>";	
			//infoContent += "<div class=\'content\'>"+item.content.substring(0,250).linkify()+"...</div>";
			
			infoContent += "</div>";
			/*PRINT ON THE FEED*/
			//$('#newsfeed').append('<li class=\'mapHighlighter\' infoId=\''+item._id+'\'><i class=\'icon-eye-open\' ></i> '+item.title+'</li>')
			if(top==1)
				$('#newsfeed').prepend('<li class=\'mapHighlighterDetails\' infoId=\''+item._id+'\' >'+infoContent+'</li>');
			else	
				$('#newsfeed').append('<li class=\'mapHighlighterDetails\' infoId=\''+item._id+'\' >'+infoContent+'</li>');
			
			

			if (scrollTo==1) {  
				$('#newsfeedContent').mCustomScrollbar("update");
				$('#newsfeedContent').mCustomScrollbar("scrollTo","ul#newsfeed");

			}  
		}

		function printLoadingFeedItem(){
			$('.loadingfeeditem').hide();
			if(skip < infoArray.length - 10){
				infoContent = "<div class=\'infowindow loadingfeeditem\'></div>";					
				$('#newsfeed').append('<li class=\'mapHighlighterDetails\'>'+infoContent+'</li>');
			}
			
		}

		function printEmptyFeedItem(){
			$('.emptyfeeditem').hide();
			infoContent = "<div class=\'infowindow emptyfeeditem\'>Aucune info !</div>";					
			$('#newsfeed').append('<li class=\'mapHighlighterDetails\'>'+infoContent+'</li>');
		}

		function printArrayFeedItem(){
			skip = skip + 10;
			var itemArray = infoArray.slice(skip,skip+10);
			$.each(itemArray,function(key,val){
				printFeedItem(val,0,0);
			});
			printLoadingFeedItem();
			$('#newsfeedContent').mCustomScrollbar("update");
		}

		function getItemDetails(el){

			$("#newsfeed").find(".myitem").hide();
			var currentItem = $(el);
			var infoid = currentItem.attr("infoid")
			if (currentItem.find(".loadingMore").length > 0 || currentItem.find(".myitem").length > 0)
			{
				currentItem.find(".myitem").slideToggle();				
				return;
			}


			
			currentItem.append('<img src="images/loader_big.gif" class="loadingMore">');
			$.getJSON('/api/afeed', { id: infoid } ,function(data) {

				var val = data.info[0];
				var item = createFeedPageItem(val);
				currentItem.find(".loadingMore").remove();
				currentItem.append(item);
				setshortUrl();
				setLikeSystem();
			});
			
		}


		function createFeedPageItem(val)
		{
			item = $("<div />");
			item.attr("class", "myitem");

			

			/*create the content element*/
			content = $("<div />");
			content.attr("class", "content");
			content.html("<div class='theContent'>" + val.content + "</div>");
			
			content.append("<br />");
			
			/* create the likes system */ 
			var yakLikes = $("<span />");
			yakLikes.attr("class", "yakLikes");
			yakLikes.attr("rel", val._id);

			var yakComments = $("<span />");
			yakComments.attr("class", "yakComments");
			yakComments.attr("rel", val._id);
			//console.log(val.yakComments);
			yakComments.html("Il y en a " + val.yakComments.length + " comments");

			yakComments.click(function(){
				if ($(this).parent().find(".commentBox").length > 0)
				{
					return;
				}
					
				var currEleComment = $(this);
				var divComment = $("<div />");
				divComment.attr("class", "commentBox");
				$(this).append('<img class="loadingMore" src="images/loader_big.gif">');
				$.getJSON('/api/afeed', { id: $(this).attr("rel")} ,function(data) {
						$.each(data.info[0].yakComments, function(key, val){
							divComment.append(drawAComment(val, 'map'));
						});
						divComment.append('<textarea class="yakTextarea" placeholder="Ajouter un commentaire..."></textarea>');

						divComment.find("textarea").keypress(function(event){
							if (event.keyCode == 13) {
								var comment = $(this).val();
								var theArea = $(this);
								$(this).val("posting...Please wait");
								$(this).attr("disabled", "disabled");
								var newComment = new Array();
								newComment.username = user.login;
								newComment.userid = user._id;
								newComment.comment = comment;
								newComment.userthumb = user.thumb;
								newComment.date = new Date();
								$.post('/setComment', {infoId : currEleComment.attr("rel"), username: user.login, userthumb: user.thumb, comment: comment} , function(res){
									if (res == 'updated')
									{
										theArea.val("");
										theArea.removeAttr("disabled");
										theArea.before(drawAComment(newComment));
									}

				});
							};
						});
						currEleComment.find(".loadingMore").remove();
						currEleComment.after(divComment);
				});	
			});

			var thumbsUp = "<i class='icon-thumbs-up'></i>";
			var thumbsDown = "<i class='icon-thumbs-down'></i>";
			if($.inArray(user._id, val.yaklikeUsersIds) > -1)
			{
				thumbsUp = "you like this";
			}

			if($.inArray(user._id, val.yakunlikeUsersIds) > -1)
			{
				thumbsDown = "you dislike this";
			}

			if($.inArray(user._id, val.yaklikeUsersIds) > -1 && $.inArray(user._id, val.yakunlikeUsersIds) == -1)
			{
				yakLikes.append("déjà aimé " + "<span class='theUps'>" + val.likes + "</span> likes- " + "" + "<span class='theDowns'>" + val.unlikes +"</span> dislikes");			

			}
			else if($.inArray(user._id, val.yaklikeUsersIds) == -1 && $.inArray(user._id, val.yakunlikeUsersIds) > -1)
			{
				yakLikes.append("déjà détesté " + "<span class='theUps'>" + val.likes + "</span> likes- " + "" + "<span class='theDowns'>" + val.unlikes +"</span> dislikes");							
			}
			else
			{

			yakLikes.append(thumbsUp + "<span class='theUps'>" + val.likes + "</span> likes- " + thumbsDown + "<span class='theDowns'>" + val.unlikes +"</span> dislikes");			

			}


			more = $("<a />");
			more.attr("class", "more");
			more.attr("href", val.outGoingLink);
			more.attr("target", "_blank");
			more.attr("rel", val._id);
			more.attr("data-toggle", "data-toggle");
			more.html("read from source");
			
			content.append("<div class='shareMe'><i style='background: none' class='icon-share' title='Share Me'><img src='images/ftg.png' class='ftgIcon' /> </i></div>");
			content.find(".theContent").append(more);
			item.append(content);
			item.append(yakLikes);
			item.append(yakComments);
			item.append()
			return item;	
		}