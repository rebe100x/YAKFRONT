include ../mixins/menu.jade
include ../mixins/locationChooser.jade


mixin menu('post')
mixin locationChooser()

div.container-fluid
	div.row-fluid
		div.span3.leftOverMapBox
			- if (flash.warn)
				div.alert.fade.in
					button.close(type="button",data-dismiss="alert")
						x
					strong=flash.warn
			div= title.test
			form(action='/actu', method='POST')
				input#yakcatInput(type='hidden', name='yakcatInput', value='')
				p
					label(for='title') Titre:
					input(type='text', name='title', id='title')
				p
					label(for='content') Texte:
					textarea(name='content', id='content')
				p
					label(for='category') Cat√©gorie(s):
					input#yakcat(type="text",data-provide="typeahead", name="category", autocomplete="off")
				p
					label(for='latitude') Latitude: ( click on the map )
					input#latitude(type="text",data-provide="typeahead", name="latitude")
				p
					label(for='longitude') Longitude: ( click on the map )
					input#longitude(type="text",data-provide="typeahead", name="longitude")
				p
					label(for='link') Lien:
					input.link(type="text",data-provide="typeahead", name="link")
				
				p
					input(type='submit', name='submit', id='submit', value='Envoyer')
		div.span9(style='z-index:0;') 
			div#mymap
		
	script
		/*INIT*/	
		var curPos = {'x':0,'y':0,'z':13};
		var geolocalized = 0;
		var infowindow = null;

		$(document).ready(function() {
		
			/*if(navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(getHTML5Pos,getErrHTML5Pos);
			}else {
				$('#locationChooser').modal('show');
				x = 48.851875;
				y = 2.356374;
				z = 13;
				curPos = {'x':x,'y':y,'z':z};
				google.maps.event.addDomListener(window, 'load', initialize(curPos.x,curPos.y,curPos.z)); 
			}*/
			if($.cookie("geoloc")){
				curPos = JSON.parse($.cookie("geoloc"));
				google.maps.event.addDomListener(window, 'load', initialize(curPos.x,curPos.y,curPos.z));
			}else{
				if(navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(getHTML5Pos,getErrHTML5Pos);
				}else {
					x = 48.851875;
					y = 2.356374;
					z = 13;
					curPos = {'x':x,'y':y,'z':z};
					google.maps.event.addDomListener(window, 'load', initialize(curPos.x,curPos.y,curPos.z));
				}
			}	
			
			
			var yakcat = [];
			$('#yakcat').typeahead({
				source: function (typeahead, query) {
					$.ajax({
							url: "/api/cats",						
							success: function( data ) {
								typeahead.process(data.cats);
							}
						})},
				property: "title",
				onselect: function(obj) { 
					$("label[for='category']").after("<div><i class='icon-remove'  onclick='yakcat.cleanArray(\""+obj._id+"\");$(\"#yakcatInput\").val(JSON.stringify(yakcat));$(this).parent().remove();'></i> "+obj.title+"</div>");
					$('#yakcat').val('').focus();
					yakcat.push(obj);
					$("#yakcatInput").val(JSON.stringify(yakcat));
				}
			});
		});

		function initialize(x,y,z) {
		
			// set user cookie ( when user comes back he is located where he stopped browsing )
			$.cookie("geoloc", JSON.stringify(curPos),{ expires: 10000 });
			console.log(curPos);
			
			var center = new google.maps.LatLng(x,y);
			infowindow = new google.maps.InfoWindow({content: ".",maxWidth : 300});
			var map = new google.maps.Map(document.getElementById('mymap'), {
				zoom:z,
				center:center,
				mapTypeId:google.maps.MapTypeId.ROADMAP
			});

			var markerLocation = new google.maps.Marker({
				visible:false,
				map:map,
				draggable:true,
				icon:'images/beachflag.png'
			});
			
			var markers = [];
			
			$.getJSON('/api/infos',function(data) {
			
				var items = [];
				
				$.each(data.info, function(key,val) {
				//console.log(val.location);
					
					var latLng = new google.maps.LatLng(val.location['lat'],val.location['lng']);
					var marker = new google.maps.Marker({position: latLng});
					markers.push(marker);
					
					google.maps.event.addListener(marker, 'click', function() {
						//map.setZoom(8);
						//map.setCenter(marker.getPosition());
						var dateTmp = new Date(val.creationDate);
						//console.log(val.creationDate);
						var dateCreation = dateTmp.getDate()+'/'+(dateTmp.getMonth()+1)+'/'+dateTmp.getFullYear();
						var infoContent = "<div class=\'infowindow\' >";
						if(!(typeof val.thumb === 'undefined'))
							infoContent += "<img src=\'http://dev.backend.yakwala.com/BACKEND/"+val.thumb+"\' />";
						infoContent += "<div class=\'title\'> "+val.title+" ("+dateCreation+")</div>";
						infoContent += "<div class=\'content\'>"+val.content.substring(0,250)+"...</div>";
						if(!(typeof val.outGoingLink === 'undefined'))
							infoContent += "<div class=\'readmore\'><a target=\'_blank\' href=\'"+val.outGoingLink+"\'> Read more</a></div>";
						infoContent += "</div>";
						infowindow.setContent(infoContent);
						infowindow.open(map, this);
					});	
					
				});
				
				var markerClustererOptions = {gridSize:30,maxZoom: 17};
				var markerCluster = new MarkerClusterer(map, markers,markerClustererOptions);
				
				
				google.maps.event.addListener(map, 'click', function(event) {
						placeMarker(event.latLng,markerLocation);
					});
			});	
		}