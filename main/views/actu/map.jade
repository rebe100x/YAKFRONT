include ../mixins/menu.jade

mixin menu('map')

div.modal.hide.fade#locationChooser
	div.modal-header
		button.close(type="button", data-dismiss="modal") x
		h3 Choisissez votre zone :
	div.modal-body
		p.alertText Yakwala ne couvre pas encore la zone où vous vous trouvez, vous pouvez actuellement naviguer sur :
			ul.unstyled
				li.zoneLoc#zone1
					i.icon-map-marker
					span  Paris, France
				li.zoneLoc#zone2 
					i.icon-map-marker
					span  Montpellier, France
				li.zoneLoc#zone3
					i.icon-map-marker
					span  Egézée, Belgique
	div.modal-footer
		span.btn(data-dismiss="modal") Laissez moi explorer tout seul !
				

div.container-fluid
	div.row-fluid
		div.span3
		div.span9
			div#mymap
script
	$(document).ready(function() {
	
		/*INIT*/	
		curPos = {'x':0,'y':0,'z':13};
		geolocalized = 0;
		infowindow = null;
		
		if(navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(getHTML5Pos,getErrHTML5Pos);
		}else {
			x = 48.851875;
			y = 2.356374;
			z = 13;
			curPos = {'x':x,'y':y,'z':z};
			google.maps.event.addDomListener(window, 'load', initialize(curPos.x,curPos.y,curPos.z)); 
		}		
	});


	function initialize(x,y,z){

		var center = new google.maps.LatLng(x,y);
		infowindow = new google.maps.InfoWindow({content: ".",maxWidth : 300});
		var map = new google.maps.Map(document.getElementById('mymap'), {
			zoom: z,
			center: center,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		});

		/*
		var markerLocation = new google.maps.Marker({
			visible:false,
			map:map,
			draggable:true,
			icon:'images/beachflag.png',
		});
		*/
		var markers = [];
		$.getJSON('/api/infos',function(data) {
		
			var items = [];
			
			$.each(data.info, function(key,val) {
			//console.log(val.location);
				
				var latLng = new google.maps.LatLng(val.location['lat'],val.location['lng']);
				var marker = new google.maps.Marker({position: latLng});
				markers.push(marker);
				
				google.maps.event.addListener(marker, 'click', function() {
					//map.setZoom(8);
					//map.setCenter(marker.getPosition());
					var dateTmp = new Date(val.creationDate);
					//console.log(val.creationDate);
					var dateCreation = dateTmp.getDate()+'/'+(dateTmp.getMonth()+1)+'/'+dateTmp.getFullYear();
					var infoContent = "<div class=\'infowindow\' >";
					if(!(typeof val.thumb === 'undefined'))
						infoContent += "<img src=\'http://dev.backend.yakwala.com/BACKEND/"+val.thumb+"\' />";
					infoContent += "<div class=\'title\'> "+val.title+" ("+dateCreation+")</div>";
					infoContent += "<div class=\'content\'>"+val.content.substring(0,250)+"...</div>";
					if(!(typeof val.outGoingLink === 'undefined'))
						infoContent += "<div class=\'readmore\'><a target=\'_blank\' href=\'"+val.outGoingLink+"\'> Read more</a></div>";
					infoContent += "</div>";
					infowindow.setContent(infoContent);
					infowindow.open(map, this);
				});	
				
			});
			
			var markerClustererOptions = {gridSize:30,maxZoom: 17};
			var markerCluster = new MarkerClusterer(map, markers,markerClustererOptions);
			
			/*
			google.maps.event.addListener(map, 'click', function(event) {
					placeMarker(event.latLng,markerLocation);
				});
			*/	
			/*
			var drawingManager = new google.maps.drawing.DrawingManager({
				drawingMode: google.maps.drawing.OverlayType.MARKER,
				drawingControl: true,
				drawingControlOptions: {
					position: google.maps.ControlPosition.BOTTOM_LEFT,
					drawingModes: [
					google.maps.drawing.OverlayType.MARKER,
					google.maps.drawing.OverlayType.RECTANGLE
					]
				},
				markerOptions: {
					icon: 'images/beachflag.png'
				},
				rectangleOptions: {
					fillColor: '#FFFFFF',
					fillOpacity: 0.5,
					strokeWeight: 2,
					clickable: false,
					editable: true,
					zIndex: 1
				}
			});
			drawingManager.setMap(map);
			*/
			/*
			google.maps.event.addListener(markerCluster, 'click', function(data) {
				console.log('data'+data);
			});*/
		});
	}