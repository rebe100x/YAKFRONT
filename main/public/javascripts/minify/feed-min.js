var infoArray=[];var mediumImage;var thumbImage;var skip=0;var zoom=1;var infoContent="";var rule=new RegExp("#([^\\s]*)","g");var rule2=new RegExp("[#]","g");var postFlag=0;var filteredInfoArray=[];var lastSearchString=null;setInterval(function(){silentUpdater()},10000);$(document).ready(function(){$("#searchBtn").click(function(){$.cookie("searchString",searchString,{expires:10000,path:"/"});var h=encodeURIComponent($("#searchStr").val());var f=$("#searchPlaceStr").val();var c=JSON.stringify({lat:curPos.x,lng:curPos.y});if(c!=""){changeLocation(c);getAndPrintInfo()}else{if(f!=""){var a={address:f,region:"fr",language:"fr"};var g=new google.maps.Geocoder();g.geocode(a,function(l,j){if(j==google.maps.GeocoderStatus.OK){var m=getPlaceFromGmapResult((l[0]))}else{var k=new Date().getTime();$("#searchStr").before("<div id='alert"+k+"' class='control-label'><i class='icon-exclamation-sign'> </i>Adresse invalide</div>");setTimeout(function(){$("#alert"+k).fadeOut()},3000)}})}}if(h!="Quoi ?"&&h!=""){searchString=h;filteredInfoArray=[];cleanFeed();$.each(infoArray,function(k,l){h=decodeURIComponent(h);var j=new RegExp("(?:^| )("+h+")","gi");if(j.test(l.title)||j.test(l.content)||j.test(l.yakCatName)||j.test(l.freeTag)||j.test(l.origin)){filteredInfoArray.push(l)}});printMapAndFeed(filteredInfoArray,1)}else{cleanFeed();searchString=null;if(infoArray.length>0){printMapAndFeed(infoArray,1)}else{getAndPrintInfo()}}if((lastSearchString==null||lastSearchString!=h)&&h.length>1){$.cookie("searchString",searchString,{expires:10000,path:"/"});var e=new Date();var b=e.setTime(e.getTime()+dateFrom*24*60*60*1000);var d={page:"feed",location:{lat:curPos.x.toString(),lng:curPos.y.toString(),},dateFrom:b.toString(),type:yakType.toString(),str:searchString};$.getJSON(conf.trackurl+"/track/user/"+user._id+"/5/"+encodeURIComponent(JSON.stringify(d)))}lastSearchString=h;$("#searchStr").removeClass("searching")});$("#newsfeed").delegate(".mapHighlighter","click",function(a){if(!$.contains($(this),a.target)&&a.target.className!="prevent-default"){getItemDetails(this)}});getAndPrintInfo()});function changeLocation(a){var b=JSON.parse(a);curPos.x=b.lat;curPos.y=b.lng}function printMapAndFeed(b,a){$.each(b,function(c,d){if(a!=1){infoArray.push(d)}if(c<10){printFeedItem(d,0,0)}});printLoadingFeedItem()}function unhighlightInfo(a,b){markerHL.setAnimation(null);markerHL.setVisible(false);if(b&&typeof(b)==="function"){b(a)}}function silentUpdater(){var a=new Date().getTime();var b="";if(yakType.inArray("5")){b="/api/geoalerts/"+curPos.x+"/"+curPos.y+"/"+rangeFromZ()+"/null/"+dateFrom+"/"+a+"/"+searchString+"/500"}else{b="/api/geoinfos/"+curPos.x+"/"+curPos.y+"/"+rangeFromZ()+"/null/"+dateFrom+"/"+a+"/"+yakType.toString()+"/"+searchString+"/500"}$.getJSON(b,function(c){if(typeof c.data!="undefined"){$.each(c.data.info,function(d,f){var e=0;$.each(infoArray,function(g,h){if(h._id==f._id){e=1}});if(e==0){printFeedItem(f,1,0);infoArray.push(f)}})}})}function getAndPrintInfo(){getHotTags(curPos,dateFrom);infoArray=[];if(typeof(yakType)=="undefined"||yakType.length==0){printEmptyFeedItem();return}var d="";if(yakType.inArray("5")){d="/api/geoalerts/"+curPos.x+"/"+curPos.y+"/"+rangeFromZ()+"/null/"+dateFrom+"/0/"+searchString+"/500"}else{d="/api/geoinfos/"+curPos.x+"/"+curPos.y+"/"+rangeFromZ()+"/null/"+dateFrom+"/0/"+yakType.toString()+"/"+searchString+"/500"}$.getJSON(d,function(e){cleanFeed();if(typeof(e.data)=="undefined"||typeof(e.data.info)=="undefined"||e.data.info.length==0){printEmptyFeedItem()}else{$.each(e.data.info,function(f,g){infoArray.push(g);if(f<10){printFeedItem(g,0,0)}});printLoadingFeedItem();if(gup("id")!=null&&gup("id")!=""){$.getJSON("/api/afeed",{id:gup("id")},function(g){infoArray.push(g.info[0]);printFeedItem(g.info[0],1,0);for(i=1;i<$(".mapHighlighterDetails[infoid="+gup("id")+"]").length;i++){$(".mapHighlighterDetails[infoid="+gup("id")+"]").eq(i).remove()}if(g.info[0].user!=undefined){var f=conf.fronturl+"/pictures/120_90/"+$(".mapHighlighterDetails[infoid="+gup("id")+"]").eq(0).attr("src");$(".mapHighlighterDetails[infoid="+gup("id")+"]").eq(0).attr("src",f)}else{var f=conf.batchurl+$(".mapHighlighterDetails[infoid="+gup("id")+"]").eq(0).find(".thumbImage img").attr("src");$(".mapHighlighterDetails[infoid="+gup("id")+"]").eq(0).find(".thumbImage img").attr("src",f)}})}}$("abbr.timeago").timeago();$("#newsfeedContent").mCustomScrollbar("update")});var c=new Date();var a=c.setTime(c.getTime()+dateFrom*24*60*60*1000);var b={page:"feed",location:{lat:curPos.x.toString(),lng:curPos.y.toString(),},dateFrom:a.toString(),type:yakType.toString(),str:searchString};$.getJSON(conf.trackurl+"/track/user/"+user._id+"/5/"+encodeURIComponent(JSON.stringify(b)))}function printFeedItem(o,l,j){var p=new Date(o.pubDate);var k=p.getDate()+"/"+(p.getMonth()+1)+"/"+p.getFullYear();p=new Date(o.dateEndPrint);var a=new Date(o.dateEndPrint);var f=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear();infoContent=$("<div />");infoContent.attr("class","infowindow mapHighlighter");infoContent.attr("infoId",o._id);var c=$("<div />");c.attr("class","yakTypeImage");c.html("<img src='/images/markers/new/type"+o.yakType+".png' />");infoContent.append(c);if(!(typeof o.thumb==="undefined")&&o.thumb!=conf.batchurl&&o.thumb!=null&&o.thumb!=""){thumbImage=o.thumb.replace("thumb/","");thumbImage=thumbImage.replace("//","/");var m=$("<div />");m.attr("class","thumbImage");m.append("<img src='"+thumbImage+"' />");infoContent.append(m)}var d=$("<div />");d.attr("class","itemTitle");d.html(o.title.linkify());thedate=buildItemDate(o);var h=$("<div />");h.attr("class","postedBy");if(o.origin.indexOf("@")!=0){o.origin="@"+o.origin}if(o.yakType!=2){h.html("Posté par <a class='prevent-default' onclick='setSearchFor(this)'>"+o.origin+"</a> <span class='date'> - "+thedate+"</span>")}else{h.html("Posté par <a class='prevent-default' onclick='setSearchFor(this)'>"+o.origin+"</a>");d.append(" - <span class='dateAgenda'>"+thedate+"</span>")}infoContent.append(d);infoContent.append(h);var b="<div class='tags'>";if(o.yakCatName.length>0){for(var g=0;g<o.yakCatName.length;g++){b+='<a class="tagHashLink prevent-default" onclick="setSearchFor(this)">#'+o.yakCatName[g]+"</a> "}}if(typeof(o.freeTag)!="undefined"){for(var g=0;g<o.freeTag.length;g++){if(o.freeTag[g]!=""){b+='<a class="tagHashLink prevent-default" onclick="setSearchFor(this)">#'+o.freeTag[g]+"</a> ";if(g<o.freeTag.length-1){b+=", "}}}}b+="</div>";infoContent.append(b);if(typeof(o.address)!="undefined"&&o.address!="null"&&o.address!=""){var e="<div class='infodetail'>"+o.address+"</div>"}if(user.login=="renaud.bessieres"||user.login=="dany.srour"){e+="<div class='infodetail'>"+k+" >> "+f+"</div>"}if(l==1){var n=$("<li />");n.attr("class","mapHighlighterDetails");n.attr("infoId",o._id);n.append(infoContent);$("#newsfeed").prepend(n)}else{var n=$("<li />");n.attr("class","mapHighlighterDetails");n.attr("infoId",o._id);n.append(infoContent);$("#newsfeed").append(n)}if(j==1){$("#newsfeedContent").mCustomScrollbar("update");$("#newsfeedContent").mCustomScrollbar("scrollTo","ul#newsfeed")}}function printLoadingFeedItem(){$(".loadingfeeditem").hide();if(skip<infoArray.length-10){infoContent="<div class='infowindow loadingfeeditem'></div>";$("#newsfeed").append("<li class='mapHighlighterDetails'>"+infoContent+"</li>")}}function printEmptyFeedItem(){$(".emptyfeeditem").hide();if($("#typeContainer .active").length>0){infoContent="<div class='infowindow emptyfeeditem'>Aucune info !</div>"}else{infoContent="<div class='infowindow emptyfeeditem'>Il n'y a pas d'info ici !!!</div>"}$("#newsfeed").append("<li class='mapHighlighterDetails'>"+infoContent+"</li>")}function printArrayFeedItem(){skip=skip+10;var a=infoArray.slice(skip,skip+10);$.each(a,function(b,c){printFeedItem(c,0,0)});printLoadingFeedItem();$("#newsfeedContent").mCustomScrollbar("update")}function getItemDetails(d){var c=$(d);var b=c.attr("infoid");if(c.find(".loadingMore").length>0||c.find(".myitem").length>0){c.find(".myitem").find(".icon-remove").remove();c.find(".itemTitle").append("<i class='icon-remove' title='close' onclick='closemyitem(this);'></i>");c.find(".myitem").show();return}c.append('<img src="images/loader_big.gif" class="loadingMore">');$.getJSON("/api/afeed",{id:b},function(f){var g=f.info[0];thumbImage=g.thumb.replace("thumb/","");thumbImage=thumbImage.replace("//","/");mediumImage=thumbImage.replace("120_90","512_0");var e=createFeedPageItem(g);c.find(".loadingMore").remove();c.append(e);c.find(".myitem").append("<i class='icon-remove' title='close' onclick='closemyitem(this);'></i>");setshortUrl();setLikeSystem();if(g.thumbFlag==2){c.find(".thumbImage").insertAfter(c.find(".tags"));c.find(".thumbImage img").attr("src",mediumImage);c.addClass("currentDetails");c.removeClass("infowindow")}else{c.find(".thumbImage img").show();c.find(".thumbImage").insertAfter(c.find(".yakTypeImage"));c.find(".infodetail").insertAfter(c.find(".tags"));$("ul#newsfeed li").removeAttr("style");$("ul#newsfeed").removeAttr("style")}c.find(".infodetail").insertAfter(c.find(".postedBy"));c.find(".icon-remove").appendTo(c.find(".itemTitle"));$("ul#newsfeed li").css("width","100%");$("ul#newsfeed").css("width","100%");$("#newsfeed li").removeClass("highlighted");c.parent().addClass("highlighted");$("body").animate({scrollTop:$('.mapHighlighter[infoId="'+c.parent().attr("infoid")+'"]').offset().top},"slow")});if($(d).find(".myitem").css("display")=="none"){$("#newsfeed").find(".myitem").hide();$(d).find(".myitem").show()}else{$(d).find(".myitem").hide()}var a={infoId:b,page:"feed"};$.getJSON(conf.trackurl+"/track/user/"+user._id+"/6/"+encodeURIComponent(JSON.stringify(a)))}function closemyitem(b){var a=$(b).parent().parent();a.find(".thumbImage img").show();a.find(".thumbImage img").attr("src",thumbImage);a.find(".thumbImage").insertAfter(a.find(".yakTypeImage"));a.find(".infodetail").insertAfter(a.find(".tags"));a.removeClass("currentDetails");a.addClass("infowindow");$("ul#newsfeed li").removeAttr("style");$("ul#newsfeed").removeAttr("style");a.find(".myitem").remove();a.find(".icon-remove").remove()}function createFeedPageItem(d){item=$("<div />");item.attr("class","myitem");content=$("<div />");content.attr("class","content");content.html("<div class='theContent'>"+d.content+"</div>");content.append("<br />");var e=$("<span />");e.attr("class","yakLikes");e.attr("rel",d._id);var a=$("<span />");a.attr("class","yakComments");a.attr("rel",d._id);setCommentText(d.yakComments.length,a);a.click(function(){if($(this).parent().find(".commentBox").length>0){return}var f=$(this);var g=$("<div />");g.attr("class","commentBox");$(this).append('<img class="loadingMore" src="images/loader_big.gif">');$.getJSON("/api/afeed",{id:$(this).attr("rel")},function(h){$.each(h.info[0].yakComments,function(j,k){g.append(drawAComment(k,f.attr("rel"),"map"))});g.append('<textarea maxlength="250" rows="3" class="yakTextarea" placeholder="Ajouter un commentaire..."></textarea>');g.find("textarea").keypress(function(k){if(k.keyCode==13){var m=$(this).val();if(m.length>250){alert("Comments only 250...");return}var l=$(this);$(this).val("posting...Please wait");$(this).attr("disabled","disabled");var j=new Array();j.infoid=f.attr("rel");j.username=user.login;j.userid=user._id;j.comment=m;j.userthumb=user.thumb;j.date=new Date();$.post("/api/setComment",{infoId:f.attr("rel"),username:user.login,userthumb:user.thumb,comment:m.substring(0,249)},function(n){if(n=="updated"){l.val("");l.removeAttr("disabled");l.before(drawAComment(j))}})}});f.find(".loadingMore").remove();f.after(g)})});var b="<i class='icon-thumbs-up'></i>&nbsp;";var c="<i class='icon-thumbs-down'></i>";if($.inArray(user._id,d.yaklikeUsersIds)>-1){b="Vous avez aimé cette info !"}if($.inArray(user._id,d.yakunlikeUsersIds)>-1){c="Vous n'avez pas aimé cette info."}if($.inArray(user._id,d.yaklikeUsersIds)>-1&&$.inArray(user._id,d.yakunlikeUsersIds)==-1){e.append("<span class='theUps'>"+d.likes+"</span> likes");e.click(function(){$(".alreadyVoted").hide();$(this).append("<span class='alreadyVoted'> Vous avez déjà donnée votre avis !</span>");setTimeout('$(".alreadyVoted").remove()',3000)})}else{if($.inArray(user._id,d.yaklikeUsersIds)==-1&&$.inArray(user._id,d.yakunlikeUsersIds)>-1){e.append("<span class='theUps'>"+d.likes+"</span> likes");e.click(function(){$(".alreadyVoted").hide();$(this).append("<span class='alreadyVoted'> Vous avez déjà donnée votre avis !</span>");setTimeout('$(".alreadyVoted").remove()',3000)})}else{e.append(b+"<span class='theUps'>"+d.likes+"</span> likes ")}}more=$("<a />");more.attr("class","more");more.attr("href",d.outGoingLink);more.attr("target","_blank");more.attr("rel",d._id);more.attr("data-toggle","data-toggle");more.html(" plus de détails...");content.append("<div class='shareMe'><i style='background: none' class='icon-share' title='Share Me'><img src='images/ftg.png' class='ftgIcon' /> </i></div>");if(typeof(d.outGoingLink)!="undefined"){content.find(".theContent").append(more)}item.append(content);item.append(e);item.append(a);item.append();return item}function rangeFromZ(){return(-1)*0.0096/1*(curPos.z)+1}function changeRange(){getAndPrintInfo()}function zFromRange(){};