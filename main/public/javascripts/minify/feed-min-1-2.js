var infoArray=[];var mediumImage;var thumbImage;var skip=0;var zoom=1;var infoContent="";var rule=new RegExp("#([^\\s]*)","g");var rule2=new RegExp("[#]","g");var postFlag=0;var filteredInfoArray=[];var lastSearchString=null;var oldLocation={lat:0,lng:0};setInterval(function(){silentUpdater()},10000);$(document).ready(function(){$("#searchBtn").unbind("click").on("click",function(){filteredInfoArray=[];var k=encodeURIComponent($("#searchStr").val());var j=$("#searchPlaceStr").val();if(j.length>=2){var d={address:j,region:"fr",language:"fr"};var g=new google.maps.Geocoder();g.geocode(d,function(o,n){if(n==google.maps.GeocoderStatus.OK){var p=getPlaceFromGmapResult((o[0]));var m=JSON.stringify({lat:curPos.x,lng:curPos.y});changeLocation(m)}else{}})}var e=decodeURIComponent(k);if(k!="Quoi ?"&&k!=""){searchString=k;cleanMarkers();cleanFeed();$.each(infoArray,function(n,o){if(o.origin.charAt(0)=="@"){o.origin=o.origin.substring(1,o.origin.length)}if(e.charAt(0)=="@"){e=e.substring(1,k.length)}if(e.charAt(0)=="#"){e=e.substring(1,k.length)}var m=new RegExp("(?:^| )("+e+")","gi");if(m.test(o.title)||m.test(o.content)||m.test(o.yakCatName.join(" "))||m.test(o.freeTag.join(" "))||m.test(o.origin)){filteredInfoArray.push(o)}});printMapAndFeed(filteredInfoArray,1)}else{cleanMarkers();cleanFeed();searchString=null;if(infoArray.length>0&&k!=""){printMapAndFeed(infoArray,1)}else{getAndPrintInfo()}}if((lastSearchString==null||lastSearchString!=k)&&k.length>1){var b=new Date();var f=b.setTime(b.getTime()+dateFrom*24*60*60*1000);var c={page:"feed",location:{lat:curPos.x.toString(),lng:curPos.y.toString(),},dateFrom:f.toString(),type:yakType.toString(),str:searchString};$.getJSON(conf.trackurl+"/track/user/"+user._id+"/5/"+encodeURIComponent(JSON.stringify(c)))}var h=new Date();var l=3*60*60*1000;h.setTime(h.getTime()+(l));$.cookie("searchString",searchString,{expires:h,path:"/"});lastSearchString=k;$("#searchStr").removeClass("searching")});if(typeof($(".ui-slider-handle").position())!="undefined"){var a=$(".ui-slider-handle").position();$("#blackBox").css("left",(a.left-87)+"px")}$("#newsfeed").unbind("click").on("click",".mapHighlighter",function(b){if(b.target.className!="prevent-default"){if($(this).find(".myitem").length==0){getItemDetails(this)}unhighlightInfo($(this),highlightInfo)}});getAndPrintInfo()});function changeLocation(a){var b=JSON.parse(a);if(a!=""&&oldLocation.lat!=b.lat&&oldLocation.lng!=b.lng){curPos.x=b.lat;curPos.y=b.lng;oldLocation=b;getAndPrintInfo()}}function printMapAndFeed(b,a){cleanFeed();cleanMarkers();$.each(b,function(f,h){var c=false;var g=false;var d=false;for(var e=user.listeNoire.user.length-1;e>=0;e--){if(h.user==user.listeNoire.user[e]._id){c=true}}for(var e=user.listeNoire.feed.length-1;e>=0;e--){if(h.feed==user.listeNoire.feed[e]._id){g=true}}for(var e=user.listeNoire.info.length-1;e>=0;e--){if(h._id==user.listeNoire.info[e]._id){d=true}}if(!c&&!g&&!d){console.log("here");if(a!=1){infoArray.push(h)}printMapItem(h,f,0);if(f<10){printFeedItem(h,0,0)}}});if(infoArray.length==0){printEmptyFeedItem()}printLoadingFeedItem();$("abbr.timeago").timeago()}function unhighlightInfo(a,b){markerHL.setAnimation(null);markerHL.setVisible(false);if(b&&typeof(b)==="function"){b(a)}}function silentUpdater(){var a=new Date().getTime();var b="";if(yakType.inArray("5")){b="/api/geoalerts/"+curPos.x+"/"+curPos.y+"/"+rangeFromZ()+"/null/"+dateFrom+"/"+a+"/"+searchString+"/500"}else{b="/api/geoinfos/"+curPos.x+"/"+curPos.y+"/"+rangeFromZ()+"/null/"+dateFrom+"/"+a+"/"+yakType.toString()+"/"+searchString+"/500"}$.getJSON(b,function(c){if(typeof c.data!="undefined"){$.each(c.data.info,function(d,f){var e=0;$.each(infoArray,function(g,h){if(h._id==f._id){e=1}});if(e==0){printFeedItem(f,1,0);infoArray.push(f)}})}})}function getAndPrintTops(){$("#topLiked").html("");var f="/api/getTopLiked/"+curPos.x+"/"+curPos.y+"/"+rangeFromZ()+"/4";var c="<ul class='TheTops'>";$.getJSON(f,function(g){if(typeof(g.data)=="undefined"||g.data.length==0){c+="<li>Pad d'info</li>"}else{$.each(g.data,function(h,j){c+="<li><a href='/news/feed?id="+j._id+"'>"+j.title+"</a><br /><span class='topCounts'>"+j.likes+"like(s)</span></li>"})}c+="</ul>";$("#topLiked").html(c)});$("#topCommented").html("");var b="/api/getTopCommented/"+curPos.x+"/"+curPos.y+"/"+rangeFromZ()+"/4";var e="<ul class='TheTops'>";$.getJSON(b,function(g){if(typeof(g.data)=="undefined"||g.data.length==0){e+="<li>Pad d'info</li>"}else{$.each(g.data,function(h,j){e+="<li><a href='/news/feed?id="+j._id+"'>"+j.title+"</a><br /><span class='topCounts'>"+j.commentsCount+"commentaire(s)</span></li>"})}e+="</ul>";$("#topCommented").html(e)});$("#topHots").html("");var d="/api/getTopHots/"+curPos.x+"/"+curPos.y+"/"+rangeFromZ()+"/4";var a="<ul class='TheTops'>";$.getJSON(d,function(g){if(typeof(g.data)=="undefined"||g.data.length==0){a+="<li>Pad d'info</li>"}else{$.each(g.data,function(h,j){a+="<li><a href='/news/feed?id="+j._id+"'>"+j.title+"</a><br /><div class='topHeat'><div class='heatLevel' style='width: "+j.heat+"%'></div></div></li>"})}a+="</ul>";$("#topHots").html(a)})}function getAndPrintInfo(){getAndPrintTops();getHotTags(curPos,dateFrom);infoArray=[];if(typeof(yakType)=="undefined"||yakType.length==0){printEmptyFeedItem();return}var d="";if(yakType.inArray("5")){d="/api/geoalerts/"+curPos.x+"/"+curPos.y+"/"+rangeFromZ()+"/null/"+dateFrom+"/0/"+searchString+"/500"}else{d="/api/geoinfos/"+curPos.x+"/"+curPos.y+"/"+rangeFromZ()+"/null/"+dateFrom+"/0/"+yakType.toString()+"/"+searchString+"/500"}$.getJSON(d,function(e){cleanFeed();if(typeof(e.data)=="undefined"||typeof(e.data.info)=="undefined"||e.data.info.length==0){printEmptyFeedItem()}else{$.each(e.data.info,function(j,l){var f=false;var k=false;var g=false;for(var h=user.listeNoire.user.length-1;h>=0;h--){if(l.user==user.listeNoire.user[h]._id){f=true}}for(var h=user.listeNoire.feed.length-1;h>=0;h--){if(l.feed==user.listeNoire.feed[h]._id){k=true}}for(var h=user.listeNoire.info.length-1;h>=0;h--){if(l._id==user.listeNoire.info[h]._id){g=true}}if(!f&&!k&&!g){infoArray.push(l);if(j<10){printFeedItem(l,0,0)}}});if(infoArray.length==0){printEmptyFeedItem()}printLoadingFeedItem();if(gup("id")!=null&&gup("id")!=""){$.getJSON("/api/afeed",{id:gup("id")},function(g){infoArray.push(g.info[0]);printFeedItem(g.info[0],1,0);for(i=1;i<$(".mapHighlighterDetails[infoid="+gup("id")+"]").length;i++){$(".mapHighlighterDetails[infoid="+gup("id")+"]").eq(i).remove()}if(g.info[0].user!=undefined){var f=conf.fronturl+"/pictures/120_90/"+$(".mapHighlighterDetails[infoid="+gup("id")+"]").eq(0).attr("src");$(".mapHighlighterDetails[infoid="+gup("id")+"]").eq(0).attr("src",f)}else{var f=conf.batchurl+$(".mapHighlighterDetails[infoid="+gup("id")+"]").eq(0).find(".thumbImage img").attr("src");$(".mapHighlighterDetails[infoid="+gup("id")+"]").eq(0).find(".thumbImage img").attr("src",f)}})}}$("abbr.timeago").timeago();$("#newsfeedContent").mCustomScrollbar("update")});var c=new Date();var a=c.setTime(c.getTime()+dateFrom*24*60*60*1000);var b={page:"feed",location:{lat:curPos.x.toString(),lng:curPos.y.toString(),},dateFrom:a.toString(),type:yakType.toString(),str:searchString};$.getJSON(conf.trackurl+"/track/user/"+user._id+"/5/"+encodeURIComponent(JSON.stringify(b)))}function printFeedItem(q,n,k){var r=new Date(q.pubDate);var l=r.getDate()+"/"+(r.getMonth()+1)+"/"+r.getFullYear();r=new Date(q.dateEndPrint);var a=new Date(q.dateEndPrint);var f=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear();infoContent=$("<div />");infoContent.attr("class","infowindow mapHighlighter");infoContent.attr("infoId",q._id);if(!(typeof q.thumb==="undefined")&&q.thumb!=conf.batchurl&&q.thumb!=null&&q.thumb!=""){thumbImage=q.thumb.replace("thumb/","");var o=$("<div />");o.attr("class","thumbImage");o.append("<img src='"+thumbImage+"' />");infoContent.append(o)}var c=$("<div />");c.attr("class","yakTypeImage");c.html("<img src='/images/markers/new/type"+q.yakType+".png' />");infoContent.append(c);var d=$("<div />");d.attr("class","itemTitle");d.html(q.title.linkify());thedate=buildItemDate(q);var j=$("<div />");j.attr("class","postedBy");var h="showUserProfile(this)";var m="<input type='hidden' value='"+q.user+"' />";if(typeof q.feed!="undefined"){h="showFeedProfile(this);";m="<input type='hidden' value='"+q.feed+"' />"}if(q.origin.indexOf("@")!=0){q.origin="@"+q.origin}if(q.yakType!=2){j.html("Posté par <a class='prevent-default' onclick='"+h+"'>"+q.origin+"</a>"+m+"<span class='date'> - "+thedate+"</span>")}else{j.html("Posté par <a class='prevent-default' onclick='"+h+"'>"+q.origin+"</a>"+m);d.append(" - <span class='dateAgenda'>"+thedate+"</span>")}infoContent.append(d);infoContent.append(j);var b="<div class='tags'>";if(q.yakCatName.length>0){for(var g=0;g<q.yakCatName.length;g++){b+='<a class="tagHashLink prevent-default" onclick="setSearchFor(this)">#'+q.yakCatName[g]+"</a> "}}if(typeof(q.freeTag)!="undefined"){for(var g=0;g<q.freeTag.length;g++){if(q.freeTag[g]!=""){b+='<a class="tagHashLink prevent-default" onclick="setSearchFor(this)">#'+q.freeTag[g]+"</a> ";if(g<q.freeTag.length-1){b+=", "}}}}b+="</div>";infoContent.append(b);if(typeof(q.address)!="undefined"&&q.address!="null"&&q.address!=""){var e="<div class='infodetail'>"+q.address+"</div>";if(user.login=="renaud.bessieres"||user.login=="dany.srour"){e+="<div class='infodetail'>"+l+" >> "+f+"</div>"}infoContent.append(e)}if(n==1){var p=$("<li />");p.attr("class","mapHighlighterDetails");p.attr("infoId",q._id);p.append(infoContent);$("#newsfeed").prepend(p)}else{var p=$("<li />");p.attr("class","mapHighlighterDetails");p.attr("infoId",q._id);p.append(infoContent);$("#newsfeed").append(p)}if(k==1){}}function printLoadingFeedItem(){$(".loadingfeeditem").hide();if(skip<infoArray.length-10){infoContent="<div class='infowindow loadingfeeditem'></div>";$("#newsfeed").append("<li class='mapHighlighterDetails'>"+infoContent+"</li>")}}function printEmptyFeedItem(){$(".emptyfeeditem").hide();if($("#typeContainer .active").length>0){infoContent="<div class='infowindow emptyfeeditem'>Aucune info !</div>"}else{infoContent="<div class='infowindow emptyfeeditem'>Il n'y a pas d'info ici !!!</div>"}$("#newsfeed").append("<li class='mapHighlighterDetails'>"+infoContent+"</li>")}function printArrayFeedItem(){skip=skip+10;var a=infoArray.slice(skip,skip+10);$.each(a,function(b,c){printFeedItem(c,0,0)});printLoadingFeedItem();$("#newsfeedContent").mCustomScrollbar("update")}function closeAllItems(){$("#newsfeed .icon-remove").trigger("click")}function getItemDetails(c){closeAllItems();var b=$(c);var a=b.attr("infoid");if(b.find(".loadingMore").length>0||b.find(".myitem").length>0){b.find(".icon-remove").remove();b.prepend("<i class='icon-remove' title='close' onclick='closemyitem(this);'></i>");b.find(".myitem").show();return}b.append('<img src="images/loader_big.gif" class="loadingMore">');$.each(infoArray,function(e,g){if(a==g._id){thumbImage=g.thumb.replace("thumb/","");mediumImage=thumbImage.replace("120_90","512_0");var f=createFeedPageItem(g);b.find(".loadingMore").remove();b.append(f);b.prepend("<i class='icon-remove' title='close' rel='"+thumbImage+"' onclick='closemyitem(this);'></i>");setshortUrl();setLikeSystem("map");if(g.thumbFlag==2){b.find(".thumbImage").insertAfter(b.find(".tags"));b.find(".thumbImage img").attr("src",mediumImage);b.find(".thumbImage img").addClass("mediumSizeThumb")}else{b.find(".thumbImage img").show();b.find(".infodetail").insertAfter(b.find(".tags"));$("ul#newsfeed li").removeAttr("style");$("ul#newsfeed").removeAttr("style")}b.find(".infodetail").insertAfter(b.find(".postedBy"));$("ul#newsfeed li").css("width","100%");$("ul#newsfeed").css("width","100%");$("#newsfeed li").removeClass("highlighted");b.parent().addClass("highlighted");$("#newsfeedContent").mCustomScrollbar("scrollTo",'.mapHighlighter[infoId="'+b.parent().attr("infoid")+'"]');var d={infoId:a,page:"map"};$.getJSON(conf.trackurl+"/track/user/"+user._id+"/6/"+encodeURIComponent(JSON.stringify(d)))}})}function closemyitem(b){var a=$(b).parent().parent();a.find(".thumbImage img").show();a.find(".thumbImage img").attr("src",$(b).attr("rel"));a.find(".thumbImage").insertBefore(a.find(".yakTypeImage"));a.find(".infodetail").insertAfter(a.find(".tags"));a.removeClass("currentDetails");a.addClass("infowindow");$("ul#newsfeed li").removeAttr("style");$("ul#newsfeed").removeAttr("style");a.find(".myitem").remove();a.find(".icon-remove").remove();a.attr("class","mapHighlighterDetails")}function stopScroll(){return false}function createFeedPageItem(g){var e=$("<div />");e.attr("class","myitem");content=$("<div />");content.attr("class","content");content.html("<div class='theContent'>"+g.content+"</div>");content.append("<br />");var h=$("<span />");h.attr("class","yakLikes");h.attr("rel",g._id);var b=$("<span />");b.attr("class","yakComments");b.attr("rel",g._id);setCommentText(g.yakComments.length,b);b.unbind("click").on("click",function(){if($(this).parent().find(".commentBox").length>0){return}var j=$(this);var k=$("<div />");k.attr("class","commentBox");$(this).append('<img class="loadingMore" src="images/loader_big.gif">');$.each(g.yakComments,function(l,m){k.append(drawAComment(m,j.attr("rel"),"map"))});k.append('<textarea maxlength="250" rows="3" style="z-index: 1111111111111; display: block" class="yakTextarea" placeholder="Ajouter un commentaire..." onclick="return stopScroll()"></textarea>');k.find("textarea").mouseenter(function(){k.find("textarea").focus();k.find("textarea").focus(function(){return false});k.find("textarea").unbind("click").on("click",function(){return false})});k.find("textarea").mouseleave(function(){});k.find("textarea").keypress(function(m){if(m.keyCode==13){var o=$(this).val();if(o.length>250){alert("Comments only 250...");return}var n=$(this);$(this).val("posting...Please wait");$(this).attr("disabled","disabled");var l=new Array();l.infoid=j.attr("rel");l.username=user.login;l.userid=user._id;l.comment=o;l.userthumb=user.thumb;l.date=new Date();$.post("/api/setComment",{infoId:j.attr("rel"),username:user.login,userthumb:user.thumb,comment:o.substring(0,249)},function(p){if(p.meta.code=="200"){l._id=p.meta.cid;n.val("");n.removeAttr("disabled");n.before(drawAComment(l))}})}});j.find(".loadingMore").remove();j.after(k)});var d="<i class='icon-thumbs-up'></i>&nbsp;";var f="<i class='icon-thumbs-down'></i>";if($.inArray(user._id,g.yaklikeUsersIds)>-1){d="Vous avez aimé cette info !"}if($.inArray(user._id,g.yakunlikeUsersIds)>-1){f="Vous n'avez pas aimé cette info."}if($.inArray(user._id,g.yaklikeUsersIds)>-1&&$.inArray(user._id,g.yakunlikeUsersIds)==-1){h.append("<span class='theUps'>"+g.likes+"</span> likes");h.unbind("click").on("click",function(){$(".alreadyVoted").hide();$(this).append("<span class='alreadyVoted'> Vous avez déjà donnée votre avis !</span>");setTimeout('$(".alreadyVoted").remove()',3000)})}else{if($.inArray(user._id,g.yaklikeUsersIds)==-1&&$.inArray(user._id,g.yakunlikeUsersIds)>-1){h.append("<span class='theUps'>"+g.likes+"</span> likes");h.unbind("click").on("click",function(){$(".alreadyVoted").hide();$(this).append("<span class='alreadyVoted'> Vous avez déjà donnée votre avis !</span>");setTimeout('$(".alreadyVoted").remove()',3000)})}else{h.append(d+"<span class='theUps'>"+g.likes+"</span> likes ")}}more=$("<a />");more.attr("class","more");more.attr("href",g.outGoingLink);more.attr("target","_blank");more.attr("rel",g._id);more.attr("data-toggle","data-toggle");more.html(" plus de détails...");content.append("<div class='shareMe' userid='"+user._id+"'><i style='background: none' class='icon-share' title=''><img src='/images/ftg.png' class='ftgIcon' /> </i></div>");if(typeof(g.outGoingLink)!="undefined"){content.find(".theContent").append(more)}e.append(content);e.append(h);e.append(b);if(g.origin.indexOf("@")==0){var a=$("<span />");a.attr("class","yakSpam");a.attr("rel",g._id);setSpamSystem(a);e.append(a)}var c=$("<span />");c.attr("class","yakBlackList");c.attr("rel",g._id);setyakBlackListSystem(c);e.append(c);return e}function rangeFromZ(){return(-1)*0.0096/1*(curPos.z)+1}function changeRange(){getAndPrintInfo()}function zFromRange(){}function cleanMarkers(){}function numAlertsSearch(){if(!yakType.inArray("5")){var a="";dateLastCheck=new Date(user.alertsLastCheck);a="/api/geoalertsNumber/"+curPos.x+"/"+curPos.y+"/"+curPos.z+"/null/"+dateFrom+"/"+dateLastCheck.getTime();$.getJSON(a,function(b){console.log(b);if(b.data.info!="-1"&&b.data.info!="0"){$("#alertsNumber").html(b.data.info)}})}};